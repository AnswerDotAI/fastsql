# Source


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## [`Database`](https://answerdotai.github.io/fastsql/core.html#database) and [`DBTable`](https://answerdotai.github.io/fastsql/core.html#dbtable)

We create a
[`Database`](https://answerdotai.github.io/fastsql/core.html#database)
class and a
[`DBTable`](https://answerdotai.github.io/fastsql/core.html#dbtable)
class (which is returned by
[`Database.create`](https://answerdotai.github.io/fastsql/core.html#database.create)),
using sqlalchemy v2. These classes will allow us to directly work with
dataclasses such as these:

``` python
class User: name:str; pwd:str
class Todo: title:str; name:str; id:int; done:bool=False; details:str=''
class Student: id:int; grad_year:int; name:str
```

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L15"
target="_blank" style="float:right; font-size:smaller">source</a>

### Database

>  Database (conn_str)

*A connection to a SQLAlchemy database*

``` python
db = Database("sqlite:///:memory:")
# db = Database("postgresql://")
```

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L31"
target="_blank" style="float:right; font-size:smaller">source</a>

### DBTable

>  DBTable (table:sqlalchemy.sql.schema.Table, database:__main__.Database,
>               cls)

*A connection to a SQLAlchemy table, created if needed*

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L58"
target="_blank" style="float:right; font-size:smaller">source</a>

### Database.create

>  Database.create (cls:type, pk='id', name:str|None=None)

*Get a table object, creating in DB if needed*

``` python
users = db.create(User, pk='name')
todos = db.create(Todo, pk='id')
students = db.create(Student, pk=('id', 'grad_year'))
```

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L69"
target="_blank" style="float:right; font-size:smaller">source</a>

### Database.schema

>  Database.schema ()

*Show all tables and columns*

``` python
print(db.schema())
```

    Table: student
      * id: INTEGER
      * grad_year: INTEGER
      - name: VARCHAR
    Table: todo
      - title: VARCHAR
      - name: VARCHAR
      * id: INTEGER
      - done: BOOLEAN
      - details: VARCHAR
    Table: user
      * name: VARCHAR
      - pwd: VARCHAR

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L83"
target="_blank" style="float:right; font-size:smaller">source</a>

### DBTable.exists

>  DBTable.exists ()

*Check if this table exists in the DB*

``` python
users.exists()
```

    True

``` python
u0 = User('jph','foo')
u1 = User('rlt','bar')
t0 = Todo('do it', 'jph')
t1 = Todo('get it done', 'rlt')
```

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L89"
target="_blank" style="float:right; font-size:smaller">source</a>

### DBTable.insert

>  DBTable.insert (obj)

*Insert an object into this table, and return it*

``` python
t = todos.insert(t0)
assert t.id
t
```

    Todo(title='do it', name='jph', id=1, done=False, details='')

``` python
u = users.insert(u0)
assert u.name=='jph'
users.insert(u1)
u
```

    User(name='jph', pwd='foo')

``` python
todos.insert(t1)
```

    Todo(title='get it done', name='rlt', id=2, done=False, details='')

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L99"
target="_blank" style="float:right; font-size:smaller">source</a>

### DBTable.\_\_call\_\_

>  DBTable.__call__ (where:str|None=None,
>                        where_args:Union[Iterable,dict,NoneType]=None,
>                        order_by:str|None=None, limit:int|None=None,
>                        offset:int|None=None, select:str='*', **kw)

*Result of `select` query on the table*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>where</td>
<td>str | None</td>
<td>None</td>
<td>SQL where fragment to use, for example <code>id &gt; ?</code></td>
</tr>
<tr>
<td>where_args</td>
<td>Union</td>
<td>None</td>
<td>Parameters to use with <code>where</code>; iterable for
<code>id&gt;?</code>, or dict for <code>id&gt;:id</code></td>
</tr>
<tr>
<td>order_by</td>
<td>str | None</td>
<td>None</td>
<td>Column or fragment of SQL to order by</td>
</tr>
<tr>
<td>limit</td>
<td>int | None</td>
<td>None</td>
<td>Number of rows to limit to</td>
</tr>
<tr>
<td>offset</td>
<td>int | None</td>
<td>None</td>
<td>SQL offset</td>
</tr>
<tr>
<td>select</td>
<td>str</td>
<td>*</td>
<td>Comma-separated list of columns to select</td>
</tr>
<tr>
<td>kw</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>list</strong></td>
<td></td>
<td><strong>List of returned objects</strong></td>
</tr>
</tbody>
</table>

``` python
assert users()==[u0,u1]
users()
```

    [User(name='jph', pwd='foo'), User(name='rlt', pwd='bar')]

``` python
r = users(where="pwd LIKE :pwd", pwd="b%")
assert r==[u1]
r
```

    [User(name='rlt', pwd='bar')]

``` python
users.xtra(name='rlt')
users(order_by='name')
```

    [User(name='rlt', pwd='bar')]

``` python
users(where='name="rlt"')
```

    [User(name='rlt', pwd='bar')]

``` python
users(where='name="jph"')
```

    []

``` python
assert len(todos())==2
todos()
```

    [Todo(title='do it', name='jph', id=1, done=False, details=''),
     Todo(title='get it done', name='rlt', id=2, done=False, details='')]

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L140"
target="_blank" style="float:right; font-size:smaller">source</a>

### NotFoundError

*Common base class for all non-exit exceptions.*

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L144"
target="_blank" style="float:right; font-size:smaller">source</a>

### DBTable.\_\_getitem\_\_

>  DBTable.__getitem__ (key)

*Get item with PK `key`*

``` python
users.xtra(name='jph')

assert users['jph']==u0
users['jph']
```

    User(name='jph', pwd='foo')

``` python
users.xtra(name='rlt')
test_fail(lambda: users['jph']==u0)
```

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L153"
target="_blank" style="float:right; font-size:smaller">source</a>

### DBTable.update

>  DBTable.update (obj=None, **kw)

``` python
users.xtra(name='jph')
u.pwd = 'new'
users.update(u)
users.xtra()
users()
```

    [User(name='jph', pwd='new'), User(name='rlt', pwd='bar')]

``` python
users.xtra(name='rlt')
u.pwd = 'foo'
users.update(u)
users.xtra()
test_eq(users['jph'].pwd, 'new')
```

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L164"
target="_blank" style="float:right; font-size:smaller">source</a>

### DBTable.delete

>  DBTable.delete (key)

*Delete item with PK `key` and return count deleted*

``` python
assert users.delete('jph')
test_fail(lambda: users['jph'])
```

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L172"
target="_blank" style="float:right; font-size:smaller">source</a>

### DBTable.\_\_contains\_\_

>  DBTable.__contains__ (pk_values:Union[list,tuple,str,int])

*Is the item with the specified primary key value in this table?*

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>pk_values</td>
<td>Union</td>
<td>A single value, or a tuple of values for tables that have a compound
primary key</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td></td>
</tr>
</tbody>
</table>

Demonstration with single field primary key:

``` python
assert not 'jph' in users
assert 'rlt' in users
```

For compound primary keys, lets whether a student is in the students
table or not.

``` python
students.insert(Student(1, 2021, 'jph'))
```

    Student(id=1, grad_year=2021, name='jph')

``` python
assert (1,2021) in students
assert (1,2030) not in students
```

## SQLAlchemy helpers

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L197"
target="_blank" style="float:right; font-size:smaller">source</a>

### ReadOnlyColumnCollection.\_\_dir\_\_

>  ReadOnlyColumnCollection.__dir__ ()

*Default dir() implementation.*

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L194"
target="_blank" style="float:right; font-size:smaller">source</a>

### MetaData.\_\_dir\_\_

>  MetaData.__dir__ ()

*Default dir() implementation.*

``` python
dbm = db.meta
```

``` python
' '.join(dbm.tables)
```

    'user todo student'

``` python
t = dbm.todo
```

``` python
list(t.c)
```

    [Column('title', String(), table=<todo>),
     Column('name', String(), table=<todo>),
     Column('id', Integer(), table=<todo>, primary_key=True, nullable=False),
     Column('done', Boolean(), table=<todo>),
     Column('details', String(), table=<todo>)]

``` python
from sqlalchemy.exc import ResourceClosedError
```

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L223"
target="_blank" style="float:right; font-size:smaller">source</a>

### MetaData.sql

>  MetaData.sql (statement, *args, **kwargs)

*Execute `statement` string and return `DataFrame` of results (if any)*

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L215"
target="_blank" style="float:right; font-size:smaller">source</a>

### Connection.sql

>  Connection.sql (statement, nm='Row', *args, **kwargs)

*Execute `statement` string and return results (if any)*

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L208"
target="_blank" style="float:right; font-size:smaller">source</a>

### CursorResult.tuples

>  CursorResult.tuples (nm='Row')

*Get all results as named tuples*

``` python
# dbm.sql('delete from todo')
# db.conn.commit()
```

``` python
rs = dbm.sql('select * from user')
rs[0]
```

    Row(name='rlt', pwd='foo')

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L229"
target="_blank" style="float:right; font-size:smaller">source</a>

### Table.get

>  Table.get (where=None, limit=None)

*Select from table, optionally limited by `where` and `limit` clauses*

``` python
t.get(t.c.title.startswith('d'), limit=5)
```

    [Row(title='do it', name='jph', id=1, done=False, details='')]

This is the query that will run behind the scenes:

``` python
print(t.select().where(t.c.title.startswith('d')).limit(5))
```

    SELECT todo.title, todo.name, todo.id, todo.done, todo.details 
    FROM todo 
    WHERE (todo.title LIKE :title_1 || '%')
     LIMIT :param_1

------------------------------------------------------------------------

<a
href="https://github.com/answerdotai/fastsql/blob/main/fastsql/core.py#L235"
target="_blank" style="float:right; font-size:smaller">source</a>

### MetaData.close

>  MetaData.close ()

*Close the connection*

``` python
dbm.close()
```
